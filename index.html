<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<link rel="stylesheet" href="./js/SlickGrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="./js/jquery/jquery-ui-1.10.2.custom.css" type="text/css"/>
<link rel="stylesheet" href="./js/SlickGrid/examples/examples.css" type="text/css"/>
<link rel="stylesheet" href="./js/SlickGrid/controls/slick.columnpicker.css" type="text/css"/>
<link rel="stylesheet" href="./css/compat.css" type="text/css">

<style type="text/css">
	* {
		font-size: 16px;
	}
	html, body {
		margin: 0;
		padding: 0;
	}
	body {
		background: white;
	}
	select {
		min-width: 160px;
	}
	.text-center {
		text-align: center;
	}
	#progress-bar {
		width: 320px;
	}
	.progress-label {
		font-size: 1.4em;
		padding: 24px 0 0;
	}
	.ui-dialog {
		z-index: 10000 !important;
	}
	div.ui-tooltip {
		max-width: 800px;
		white-space: pre-line;
	}
	.ui-tooltip-content {
		font-size: 14px;
	}
	.fit_parent {
		display: inline-block;
		width: 100%;
	}
</style>

<script src="./js/SlickGrid/lib/jquery-1.11.2.js"></script>
<script src="./js/SlickGrid/lib/jquery-ui-1.11.3.js"></script>
<script src="./js/SlickGrid/lib/jquery.event.drag-2.3.0.js"></script>
<script src="./js/jquery/jquery.blockUI.js"></script>
<script src="./js/SlickGrid/slick.core.js"></script>
<script src="./js/SlickGrid/slick.grid.js"></script>
<script src="./js/SlickGrid/slick.editors.js"></script>
<script src="./js/SlickGrid/plugins/slick.checkboxselectcolumn.js"></script>
<script src="./js/SlickGrid/plugins/slick.rowselectionmodel.js"></script>
<script src="./js/SlickGrid/plugins/slick.resizer.js"></script>
<script src="./js/SlickGrid/slick.dataview.js"></script>
<script src="./js/SlickGrid/controls/slick.columnpicker.js"></script>

<script type="text/javascript">
//<!--
	var seed_version = '1.0.0';
	var dataView;
	var grid;
	var griddata = [];
	var columns = [];
	var sortcol = '';
	var sortdir = 1;
	var config = {};
	var groups = [];
	var projects = [];
	var my_projects = {};
	var branches = [];
	var tags = [];
	var commits = [];
	var project_no = 0;
	var branch_no = 0;
	var request_page;
	var per_page = 100;
	var download_projects = [];
	var request_id;
	var download_type;
	var download_files = {};
	var simul_download_flag;
	var unique_id;
	var timer_id;
	var cancel_request = false;
	var checkboxSelector;
	var cookies = {};

	////////////////////////////////////////////////////////////////////
	$(function () {
		console.log( 'start: ', new Date() );
		$( '#download_all' ).prop( 'disabled', true );
		$( '#download_commits' ).prop( 'disabled', true );
		$( '#open_diff' ).prop( 'disabled', true ).prop( 'title', '' );
		$( '#download_latest_commit_of_main' ).prop( 'checked', false );
		$( '#download_previous_commit' ).prop( 'checked', false );
		$.getJSON( './config.json?' + Math.random(), ( data ) => {
			config = data;
			console.log( 'config: ', config );
			if ( config['cache_projects'] == 1 ) {
				$( '#reload_repository' ).css( 'visibility', '' );
				is_login( function() {		//	login
					startWaiting();
					request_page = 1;
					my_projects = {};
					request_my_projects( function() {
						console.log( 'my projects: ', new Date() );
						stopWaiting();
						get_projects( function( response ) {
							cookies = response['cookies'];
							console.log( 'get_projects: ' + response['projects'].length + ' records' );
							if ( response['projects'].length != 0 ) {
								projects = response['projects'];
								create_commits_table();
								create_griddata( true );
							} else {
								startWaiting();
								request_page = 1;
								request_projects();
							}
						} );
					} );
				},
				function() {				//	logout
					logout( function() {
						location.reload();
					} );
				} );
			} else {
				startWaiting();
				request_page = 1;
				request_projects();
			}
		} );

		$( document ).tooltip( {
			show: 10, hide: 10, track: true
		} )
		.off( 'focusin focusout' );;

		document.addEventListener( "nativemesssampleRecvMsg", function( event ) {
			stopWaiting();
			if ( event.type == 'nativemesssampleRecvMsg' ) {
				var detail = JSON.parse( event['detail'] );
				if ( detail['message'] == 'downloaded' ) {
					if ( detail['result'] != '' ) {
						alert( detail['result'] );
					}
				}
			}
		} );

		$( '#download_all' ).on( 'click', function(event) {
			var download_name = document.getElementById('download_file_name').value;
			if ( input_txt_check( download_name ) == true ) {
				simul_download_flag = 'Off';
				if ( simul_download_check() == true ) {
					download_all( event.shiftKey && event.ctrlKey );
				}
			}
		} );

		$( '#download_commits' ).on( 'click', function(event) {
			var download_name = document.getElementById('download_file_name').value;
			if ( input_txt_check( download_name ) == true ) {
				simul_download_flag = 'Off';
				download_commits( event.shiftKey && event.ctrlKey );
			}
		} );

		$( '#open_diff' ).on( 'click', function(event) {
			simul_download_flag = 'Off';
			if ( simul_download_check() == true ) {
				open_diff( event.shiftKey && event.ctrlKey );
			}
		} );

		$( '#logout' ).on( 'click', function(event) {
			logout( function() {
				projects = [];
				create_griddata();
				$( 'button, input, select, span' ).prop( 'disabled', true );
				$( '#logout' )
				.prop( 'disabled', false )
				.text( 'ログイン' )
				.prop( 'title', '再ログインします' )
				.off( 'click' )
				.on( 'click', function() {
					location.reload();
				} );
			} );
		} );

		$( '#target_group' ).on( 'change', function() {
			create_griddata();
		} );

		$( '#target_branch' ).on( 'change', function() {
			create_griddata();
		} );

		$( '#download_all_type' ).prop( 'selectedIndex', 0 );
		$( '#download_commits_type' ).prop( 'selectedIndex', 0 );
		$( '#target_branch' ).prop( 'selectedIndex', 0 );

		$( '#reload_repository' ).on( 'click', function() {
			startWaiting();
			projects = [];
			request_page = 1;
			console.log( 'start: ', new Date() );
			request_projects();
		} );

		create_grid();
	} );

	////////////////////////////////////////////////////////////////////
	function is_login( login, logout ) {
		http_request( 'GET', config['url'] + 'api/v4/user', {}, {},
			function( response ) {
				console.log( response );
				if ( response['name'] ) {
					login();
				} else {
					logout();
				}
			},
			function( response ) {
				logout();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function logout( done ) {
		http_request( 'GET', config['url'] + 'users/logout', {}, {},
			function( response ) {
				console.log( response );
				http_request( 'GET', './gitlabapp.php', { command: 'logout' }, {},
					function( response ) {
						console.log( response );
						done();
					},
					function( response ) {
						console.log( 'Error: ', response );
						done();
					} );
			},
			function( response ) {
				console.log( 'Error: ', response );
			} );
	}

	////////////////////////////////////////////////////////////////////
	function create_commits_table() {
		for ( var n = 0; n < projects.length; n ++ ) {
			var project = projects[n];
			var branch = project['branch'];
			for ( var m = 0; m < branch.length; m ++ ) {
				var commits = search_commits( projects[n]['commits'], branch[m]['commit']['id'] );
				branch[m]['commits'] = Object.values( commits );

			}
			var tag = project['tag'];
			for ( var m = 0; m < tag.length; m ++ ) {
				var commits = search_commits( projects[n]['commits'], tag[m]['commit']['id'] );
				tag[m]['commits'] = Object.values( commits );
			}
		}
	}

	////////////////////////////////////////////////////////////////////
	function search_commits( commits, id ) {
		var result = {};
		for ( var n = 0; n < commits.length; n ++ ) {
			if ( commits[n].id == id ) {
				if ( !is_ignore_message( commits[n]['message'] ) ) {
					result[n] = commits[n];
				}
				for ( var m = 0; m < commits[n]['parent_ids'].length; m ++ ) {
					var val = search_commits( commits, commits[n]['parent_ids'][m] );
					result = Object.assign( result, val );
				}
				break;
			}
		}
		return result;
	}

	////////////////////////////////////////////////////////////////////
	function get_selected( get_all ) {
		download_projects = [];
		var selectedrows = grid.getSelectedRows();
		var target_branch = $( '#target_branch' ).val();
		selectedrows.forEach( function( row ) {
			var value = dataView.getItem( row );
			var item = {};
			if ( target_branch == 'Branch' ) {
				var branch = value['branches'][value['branch_no']];
				var commits = [];
				if ( get_all ) {
					commits = branch['commits'].slice( value['commit_no'] );
				} else {
					commits = branch['commits'].slice( value['commit_no'], value['commit_no'] + 2 );
				}
			} else {
				var tag = value['tags'][value['branch_no']];
				var commits = [];
				if ( get_all ) {
					commits = tag['commits'].slice( value['commit_no'] );
				} else {
					commits = tag['commits'].slice( value['commit_no'], value['commit_no'] + 2 );
				}
			}
					if ( simul_download_flag == 'On' ) {
						add_path = config['download_name_selected_commit'];
					} else {
						add_path = '';
					}
			var from = false;
			var len = commits.length;
			while ( commits.length ) {
				var commit = commits.pop();
				if ( len == 1 || get_all || from ) {
					item = {
						id: value.id,
						path: value.path,
						name: value.project,
						commit: commit['id'],
						time: new Date( commit['committed_date'] ).toGMTString(),
						add_path: add_path,
						from: from
					};
					download_projects.push( item );
				}
				from = commit['id'];
			}
			if ( simul_download_flag == 'On' ) {
				if ( $( '#download_latest_commit_of_main' ).prop( 'checked' ) ) {
					if ( latest_commit_of_main_check(row) == true ) set_download_latest_commit_of_main(row);
				} else {
					if ( previous_commit_check(row) == true ) set_download_previous_commit(row);
				}
			}
		} );
		console.log( 'download projects: ', download_projects );
	}

	////////////////////////////////////////////////////////////////////
	function set_download_latest_commit_of_main( row ) {
		var value = dataView.getItem( row );
		var item = {};
		for ( var n = 0; n < value['branches']['length']; n ++ ) {
			if ( value['branches'][n]['name'] == value['default_branch'] ) {
				var branch = value['branches'][n];
				break;
			}
		}
		var commits = branch['commits'].slice(0);
		var from = false;
		while ( commits.length ) {
			var commit = commits.pop();
			item = {
				id: value.id,
				path: value.path,
				name: value.project,
				commit: commit['id'],
				time: new Date( commit['committed_date'] ).toGMTString(),
				add_path: config['download_name_latest_commit_of_main'],
				from: from
			};
			download_projects.push( item );
			from = commit['id'];
		}
		console.log( 'download projects: ', download_projects );
	}

	////////////////////////////////////////////////////////////////////
	function set_download_previous_commit( row ) {
		var value = dataView.getItem( row );
		var item = {};
		var branch = value['branches'][value['branch_no']];
		var before_commit_id = branch['commits'][value['commit_no']]['parent_ids'][0];
		for ( var n = 0; n < branch['commits']['length']; n ++ ) {
			if ( branch['commits'][n]['id'] == before_commit_id ) {
				break;
			}
		}
		var commits = branch['commits'].slice( n )
		var from = false;
		while ( commits.length ) {
			var commit = commits.pop();
			item = {
				id: value.id,
				path: value.path,
				name: value.project,
				commit: commit['id'],
				time: new Date( commit['committed_date'] ).toGMTString(),
				add_path: config['download_name_previous_commit'],
				from: from
			};
			download_projects.push( item );
			from = commit['id'];
		}
		console.log( 'download projects: ', download_projects );
	}

	////////////////////////////////////////////////////////////////////
	function get_projects( done ) {
		var params = {};
		params['command'] = 'get_projects';
		http_request( 'GET', './gitlabapp.php', params, {},
			function( response ) {
				if ( response['result'] && response['result'] == 'OK' ) {
					done( response );
				} else {
					alert( response['result'] );
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function put_projects( projects, done ) {
		var params = {};
		params['command'] = 'put_projects';
		params['projects'] = JSON.stringify( projects );
		http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				console.log( response );
				if ( response['result'] && response['result'] == 'OK' ) {
					done( response );
				} else {
					alert( response['result'] );
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function cache_check( type, done ) {
		var params = {};
		params['command'] = 'cache_check';
		var seed = {};
		seed['version'] = seed_version;
		seed['type'] = type;
		seed['file_type'] = download_type;
		seed['including_project'] = $( '#including_project' ).prop( 'checked' );
		seed['files'] = download_projects;
		params['seed'] = JSON.stringify( seed );
		console.log( params );
		http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				console.log( response );
				if ( response['result'] && response['result'] == 'OK' ) {
					done( response );
				} else {
					alert( response['result'] );
					stopWaiting();
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function request_cancel( hash, done ) {
		var params = {};
		params['command'] = 'cancel';
		params['id'] = hash;
		console.log( params );
		http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				if ( response['result'] && response['result'] == 'OK' ) {
					console.log( response );
					done( response );
				} else {
					alert( response['result'] );
					stopWaiting();
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
		return;
	}


	////////////////////////////////////////////////////////////////////
	function download_all( clear_cache ) {
		get_selected( true );
		if ( download_projects.length == 0 ) {
			return;
		}
		download_type = $( '#download_all_type' ).val();
		cache_check( 'all', function( response ) {
					if ( response['status'] == 'error' ) {
						alert( 'ERROR : ハッシュが重複しました。' );
					} else if ( response['status'] == 'busy' ) {
						alert( 'その他でダウンロードが進行中です。しばらくお待ちください。' );
					} else if ( response['status'] == 'ready' ) {
						if ( clear_cache ) {
							if ( confirm( 'キャッシュをクリアしますか？' ) ) {
								request_cancel( response['hash'], function( response ) {
									alert( 'キャッシュをクリアしました。' );
								} );
							}
						} else {
							var download_name = document.getElementById('download_file_name').value;
							if ( "" ==	download_name ) {
								download_name = config['default_download_name'];
							}
							var url = './gitlabapp.php?command=download&id=' + response['hash']  + '&download_file_name=' + download_name;
							document.getElementById( 'download_frame' ).src = url;
						}
					} else {
						download_files = {};
						project_no = 0;
						request_hash = response['hash'];
						startWaiting();
						request_page = 1;
						request_tree_diff();
					}
			} );
	}

	////////////////////////////////////////////////////////////////////
	function download_commits( clear_cache ) {
		get_selected( false );
		if ( download_projects.length == 0 ) {
			return;
		}
		download_type = $( '#download_commits_type' ).val();
		cache_check( 'commit', function(  response	) {
					if ( response['status'] == 'error' ) {
						alert( 'ERROR : ハッシュが重複しました。' );
					} else if ( response['status'] == 'busy' ) {
						alert( 'その他でダウンロードが進行中です。しばらくお待ちください。' );
					} else if ( response['status'] == 'ready' ) {
						if ( clear_cache ) {
							if ( confirm( 'キャッシュをクリアしますか？' ) ) {
								request_cancel( response['hash'], function( response ) {
									alert( 'キャッシュをクリアしました。' );
								} );
							}
						} else {
							var download_name = document.getElementById('download_file_name').value;
							if ( "" ==	download_name ) {
								download_name = config['default_download_name'];
							}
							var url = './gitlabapp.php?command=download&id=' + response['hash'] + '&download_file_name=' + download_name;
							document.getElementById( 'download_frame' ).src = url;
						}
					} else {
						download_files = {};
						project_no = 0;
						request_hash = response['hash'];
						startWaiting();
						request_page = 1;
						request_tree_diff();
					}
			} );
	}

	////////////////////////////////////////////////////////////////////
	function open_diff( clear_cache ) {
		get_selected( true );
		if ( download_projects.length == 0 ) {
			return;
		}
		download_type = 'diff';
		cache_check( 'all', function( response ) {
					if ( response['status'] == 'error' ) {
						alert( 'ERROR : ハッシュが重複しました。' );
					} else if ( response['status'] == 'busy' ) {
						alert( 'その他でダウンロードが進行中です。しばらくお待ちください。' );
					} else if ( response['status'] == 'ready' ) {
						if ( clear_cache ) {
							if ( confirm( 'キャッシュをクリアしますか？' ) ) {
								request_cancel( response['hash'], function( response ) {
									alert( 'キャッシュをクリアしました。' );
								} );
							}
						} else {
							var download_name = document.getElementById('download_file_name').value;
							if ( "" ==	download_name ) {
								download_name = config['default_download_name'];
							}
							window.open( 'dispdiff.html?id=' + response['hash'], response['hash'] );
						}
					} else {
						download_files = {};
						project_no = 0;
						request_hash = response['hash'];
						startWaiting();
						request_page = 1;
						request_tree_diff();
					}
			} );
	}

	////////////////////////////////////////////////////////////////////
	function succeed( type, response, done ) {
		switch( type ) {

		////	grid
		case 'groups':
			if ( response.length != 0 ) {
				groups = groups.concat( response );
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_groups();
			} else {
				request_page = 1;
				request_projects();
			}
			break;
		case 'my_projects':
			if ( response.length != 0 ) {
				for ( var n = 0; n < response.length; n ++ ) {
					if ( response[n].visibility != 'internal' ) {
						my_projects[response[n]['id']] = response[n]['name'];
					}
				}
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_my_projects( done );
			} else {
				done();
			}
			break;
		case 'projects':
			if ( response.length != 0 ) {
				for ( var n = 0; n < response.length; n ++ ) {
					if ( response[n].visibility != 'internal' ) {
						projects[projects.length] = response[n];
					}
				}
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_projects();
			} else {
				projects.sort(function(a, b) {
					if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
					if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
					if (Number(a.id) > Number(b.id)) return 1;
					if (Number(a.id) < Number(b.id)) return -1;
					return 0;
				});
				console.log( 'received projects: ' + projects.length + ' records' );
				if ( projects.length == 0 ) {
					stopWaiting();
				} else {
					branches = [];
					project_no = 0;
					request_page = 1;
					request_branches();
				}
			}
			break;
		case 'branches':
			if ( !projects[project_no]['branch'] ) projects[project_no]['branch'] = [];
			if ( response.length != 0 ) {
				branches = branches.concat( response );
				branches.sort(function(a, b) {
					if (a.name > b.name) return 1;
					if (a.name < b.name) return -1;
					return 0;
				});
			} else if ( request_page == 1 ) {
				projects.splice(project_no, 1);
				project_no --;
			}
			if ( response.length  >= per_page ) {
				request_page ++;
				request_branches();
			} else if ( ++ project_no < projects.length ) {
				if ( branches.length != 0 ) {
					projects[project_no-1]['branch'] = projects[project_no-1]['branch'].concat( branches );
				}
				branches = [];
				request_page = 1;
				request_branches();
			} else {
				if ( branches.length != 0 ) {
					projects[project_no-1]['branch'] = projects[project_no-1]['branch'].concat( branches );
				}
				tags = [];
				request_page = 1;
				project_no = 0;
				request_tags();
			}
			break;
		case 'tags':
			if ( !projects[project_no]['tag'] ) projects[project_no]['tag'] = [];
			if ( response.length != 0 ) {
				tags = tags.concat( response );
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_tags();
			} else if ( ++ project_no < projects.length ) {
				projects[project_no-1]['tag'] = projects[project_no-1]['tag'].concat( tags );
				tags = [];
				request_page = 1;
				request_tags();
			} else {
				projects[project_no-1]['tag'] = projects[project_no-1]['tag'].concat( tags );
				commits = [];
				request_page = 1;
				project_no = 0;
				request_commits();
			}
			break;
		case 'commits':
			if ( !projects[project_no]['commits'] ) projects[project_no]['commits'] = [];
			if ( response.length != 0 ) {
				commits = response.concat( commits );
			}
			if ( response.length  >= per_page ) {
				request_page ++;
				request_commits();
			} else if ( ++ project_no < projects.length ) {
				projects[project_no-1]['commits'] = projects[project_no-1]['commits'].concat( commits.reverse() );
				commits = [];
				request_page = 1;
				request_commits();
			} else {
				projects[project_no-1]['commits'] = projects[project_no-1]['commits'].concat( commits.reverse() );
				put_projects( projects, function( response ) {
					create_commits_table();
					request_page = 1;
					my_projects = {};
					request_my_projects( function() {
						create_griddata( true );
						stopWaiting();
						console.log( 'end: ', new Date() );
					} );
				} );
			}
			break;

		////	download
		case 'tree':
			if ( response.length != 0 ) {
				for ( var n = 0; n < response.length; n ++ ) {
					if ( response[n].type == 'blob' ) {
						response[n]['project'] = download_projects[project_no].id;
						response[n]['time'] = download_projects[project_no].time;
						response[n]['commit'] = request_commit;
						var path = response[n].path;
						if ( $( '#including_project' ).prop( 'checked' ) ) {
							path = download_projects[project_no]['name'] + '/' + path;
						}
						var download_name = document.getElementById('download_file_name').value;
						if ( "" == download_name ) {
							download_name = config['default_download_name'];
						}
						path = download_name + '/' + download_projects[project_no].add_path + path;
						download_files[path] = response[n];
						download_files[path]['recv_path'] = download_projects[project_no].path + '/' + response[n].path.replace( /[^\/]*$/ , '');
						download_files[path]['add_path'] = download_projects[project_no].add_path;
					}
				}
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_tree();
			} else {
				if ( ++ project_no < download_projects.length ) {
					request_page = 1;
					request_tree_diff();
				} else {
					download_start();
				}
			}
			break;
		case 'diff':
			if ( response.length != 0 ) {
				for ( var n = 0; n < response.length; n ++ ) {
					response[n]['project'] = download_projects[project_no].id;
					response[n]['time'] = download_projects[project_no].time;
					response[n]['commit'] = request_commit;
					response[n]['path'] = response[n]['new_path'];
					var path = response[n]['new_path'];
					if ( $( '#including_project' ).prop( 'checked' ) ) {
						path = download_projects[project_no]['name'] + '/' + path;
					}
					var download_name = document.getElementById('download_file_name').value;
					if ( "" ==	download_name ) {
						download_name = config['default_download_name'];
					}
					path = download_name + '/' + download_projects[project_no].add_path + path;
					if ( response[n]['deleted_file'] ) {
						if ( download_files[path] ) delete download_files[path];
					} else {
						download_files[path] = response[n];
						download_files[path]['recv_path'] = download_projects[project_no].path + '/' + response[n].new_path.replace( /[^\/]*$/ , '');
						download_files[path]['add_path'] = download_projects[project_no].add_path;
						if ( response[n]['renamed_file'] ) {
							path = download_name + '/' + download_projects[project_no].add_path;
							if ( $( '#including_project' ).prop( 'checked' ) ) {
								path = path + download_projects[project_no]['name'] + '/';
							}
							path = path + response[n]['old_path'];
							if ( download_files[path] ) delete download_files[path];
						}
					}
				}
			}
			if ( response.length >= per_page ) {
				request_page ++;
				request_diff();
			} else {
				if ( ++ project_no < download_projects.length ) {
					request_page = 1;
					request_tree_diff();
				} else {
					download_start();
				}
			}
			break;
		case 'compare':
			response = response.diffs;
			for ( var n = 0; n < response.length; n ++ ) {
				response[n]['project'] = download_projects[project_no].id;
				response[n]['time'] = download_projects[project_no].time;
				response[n]['commit'] = request_commit;
				response[n]['path'] = response[n]['new_path'];
				var path = response[n]['new_path'];
				if ( $( '#including_project' ).prop( 'checked' ) ) {
					path = download_projects[project_no]['name'] + '/' + path;
				}
				var download_name = document.getElementById('download_file_name').value;
				if ( "" ==	download_name ) {
					download_name = config['default_download_name'];
				}
				path = download_name + '/' + download_projects[project_no].add_path + path;
				if ( response[n]['deleted_file'] ) {
					if ( download_files[path] ) delete download_files[path];
				} else {
					download_files[path] = response[n];
					download_files[path]['recv_path'] = download_projects[project_no].path + '/' + response[n].new_path.replace( /[^\/]*$/ , '');
					download_files[path]['add_path'] = download_projects[project_no].add_path;
					if ( response[n]['renamed_file'] ) {
						path = download_name + '/' + download_projects[project_no].add_path;
						if ( $( '#including_project' ).prop( 'checked' ) ) {
							path = path + download_projects[project_no]['name'] + '/';
						}
						path = path + response[n]['old_path'];
						if ( download_files[path] ) delete download_files[path];
					}
				}
			}
			if ( ++ project_no < download_projects.length ) {
				request_page = 1;
				request_tree_diff();
			} else {
				download_start();
			}
		}
	}

	////////////////////////////////////////////////////////////////////
	function download_start() {
		console.log( 'download files: ', download_files );
		var files = [];
		for ( var path in download_files ) {
			var file = download_files[path];
			var path_encode = encodeURIComponent( file.path );
			var url = config['url'] + 'api/v4/projects/' + file.project + '/repository/files/' + path_encode + '/raw';
			commit_no = '';
			if ( file.commit ) {
				url += '?ref=' + file.commit;
				commit_no = file.commit;
			}
			if ( is_ignore_file_name( path ) ) {
				path = path.replace( /[^\/]+$/, '' );
				url = '';
			}
			files.push( {
				url: url,
				name: path,
				time: file.time,
				commit: commit_no,
				recv_path: file.recv_path
			} );
		}
		console.log( 'files: ', files );
		if ( files.length == 0 ) {
			var params = {};
			params['command'] = 'cancel';
			params['id'] = request_hash;
			console.log( params );
			http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				console.log( response );
				if ( response['result'] && response['result'] == 'OK' ) {
					alert( 'ダウンロードするファイルが有りません。' );
					stopWaiting();
				} else {
					alert( response['result'] );
					stopWaiting();
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
			return;
		}
		var params = {};
		params['command'] = 'recvfile';
		params['type'] = download_type;
		var download_name = document.getElementById('download_file_name').value;
		if ( "" ==	download_name ) {
			download_name = config['default_download_name'];
		}
		params['download_file_name'] = download_name;
		params['files'] = JSON.stringify( files );
		params['hash'] = request_hash;
		cancel_request = false;
		startProgress();
		http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				console.log( response );
				if ( response['result'] && response['result'] == 'OK' ) {
					unique_id = response['id'];
					check_download();
				} else {
					request_cancel( request_hash, function( response ) {
						alert( response['result'] );
						stopWaiting();
					} );
				}
			},
			function( response ) {
				console.log( 'error: ', response );
				stopWaiting();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function absUrl( relativePath ) {
		var anchor = document.createElement( 'a' );
		anchor.href = relativePath;
		return anchor.href;
	}

	////////////////////////////////////////////////////////////////////
	function check_download() {
		var params = {};
		params['command'] = 'status';
		params['id'] = unique_id;
		http_request( 'POST', './gitlabapp.php', params, {},
			function( response ) {
				var play = true;
				if ( response['status'] ) {
					if ( response['status'] == 'comp' ) {
						console.log( response );
						if ( download_type == 'diff' ) {
							window.open( 'dispdiff.html?id=' + unique_id, unique_id );
						} else {
							var download_name = document.getElementById('download_file_name').value;
							if ( "" ==	download_name ) {
								download_name = config['default_download_name'];
							}
							var url = './gitlabapp.php?command=download&id=' + unique_id + '&download_file_name=' + download_name;
							document.getElementById( 'download_frame' ).src = url;
						}
						stopWaiting();
						play = false;
					} else if ( response['status'] == 'run' ) {
						var bar = document.getElementById( 'progress-bar' );
						var txt = document.getElementById( 'progress-pct' );
						bar.value = ( response['current'] / response['total'] ) * 100;
						txt.value = bar.textContent = Math.round( bar.value );
					} else if ( response['status'] == 'error' ) {
						console.log( response );
						clearTimeout( timer_id );
						play = false;
						request_cancel( unique_id, function() {
							alert( response['message'] );
							stopWaiting();
						} );
					}
				}
				if ( cancel_request ) {
					cancel_request = false;
					if ( confirm( 'Are you sure you want to cancel the download ?' ) ) {
						play = false;
						params = {};
						params['command'] = 'cancel';
						params['id'] = unique_id;
						console.log( params );
						http_request( 'POST', './gitlabapp.php', params, {},
							function( response ) {
								console.log( response );
								stopWaiting();
							},
							function( response ) {
								console.log( 'error: ', response );
								stopWaiting();
							} );
					}
				}
				if ( play ) {
					timer_id = setTimeout( check_download(), 500 );
				}
			},
			function( response ) {
				clearTimeout( timer_id );
				console.log( 'error: ', response );
				stopWaiting();
			} );
	}

	////////////////////////////////////////////////////////////////////
	function failed( e ) {
		stopWaiting()
		alert( e );
	}

	////////////////////////////////////////////////////////////////////
	function request_tree_diff() {
		if ( !download_projects[project_no]['from'] ) {
			request_tree();
		} else {
			request_compare();
		}
	}

	////////////////////////////////////////////////////////////////////
	function request_tree() {
		request_id = download_projects[project_no].id;
		request_commit = download_projects[project_no].commit;
		var url = config['url'] + 'api/v4/projects/' + request_id + '/repository/tree';
		var headers = {};
		var data = { ref: request_commit, recursive: 'true', per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'tree', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_diff() {
		request_id = download_projects[project_no].id;
		request_commit = download_projects[project_no].commit;
		var url = config['url'] + 'api/v4/projects/' + request_id + '/repository/commits/' + request_commit + '/diff';
		var headers = {};
		var data = { per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'diff', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_compare() {
		request_id = download_projects[project_no].id;
		request_commit = download_projects[project_no].commit;
		var from = download_projects[project_no]['from'];
		var url = config['url'] + 'api/v4/projects/' + request_id + '/repository/compare';
		var headers = {};
		var data = { to: request_commit, from: from, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'compare', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_groups() {
		var url = config['url'] + 'api/v4/groups/';
		var headers = {};
		var data = { sort: 'asc', per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'groups', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_projects() {
		var url = config['url'] + 'api/v4/projects/';
		var headers = {};
		var data = { order_by: 'name', simple: 'false', sort: 'asc', per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'projects', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_my_projects( done ) {
		var url = config['url'] + 'api/v4/projects/';
		var headers = {};
		var data = { order_by: 'name', simple: 'true', sort: 'asc', per_page: per_page, page: request_page };
		http_request( 'GET', url, data, headers, function( response ) {
			succeed( 'my_projects', response, done );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_branches() {
		var project = projects[project_no].path_with_namespace;
		project = encodeURIComponent( project );
		var url = config['url'] + 'api/v4/projects/' + project + '/repository/branches';
		var headers = {};
		var data = { per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'branches', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_tags() {
		var project = projects[project_no].path_with_namespace;
		project = encodeURIComponent( project );
		var url = config['url'] + 'api/v4/projects/' + project + '/repository/tags';
		var headers = {};
		var data = { per_page: per_page, page: request_page, REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'tags', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function request_commits() {
		var project = projects[project_no].path_with_namespace;
		project = encodeURIComponent( project );
		var url = config['url'] + 'api/v4/projects/' + project + '/repository/commits';
		var headers = {};
		var data = { per_page: per_page, page: request_page, all: 'true', REQUEST_URL: url };
		http_request( 'GET', './proxyproc.php', data, headers, function( response ) {
			succeed( 'commits', response );
		}, failed );
	}

	////////////////////////////////////////////////////////////////////
	function http_request( method, url, data, headers, succeed, failed ) {
		$.ajax( { type: method,
					url: url,
					data: data,
					headers: headers,
					crossDomain: true,
					xhrFields: {
						withCredentials: true
					},
					cache: false
		} ).then(
			function( data, textStatus, errorThrown ) {
				succeed( data );
			},
			function( XMLHttpRequest, textStatus, errorThrown ) {
					console.log( XMLHttpRequest );
					var e = XMLHttpRequest.responseText;
					if ( e.match( /<title>([\s\S]+)<\/title>[\s\S]+<body>([\s\S]+)<\/body>/ ) ) {
						e = RegExp.$1 + RegExp.$2;
						e = e.replace( '<p>', '' )
						e = e.replace( '</p>', '' )
						e = e.replace( '<h1>', '' )
						e = e.replace( '</h1>', '' )
						failed( e );
					} else {
						failed( $('<div/>').text(e).html() );
					}
				} );
	}

	////////////////////////////////////////////////////////////////////
	function create_grid() {
		checkboxSelector = new Slick.CheckboxSelectColumn( {
			cssClass: "slick-cell-checkboxsel"
		} );
		columns.push( checkboxSelector.getColumnDefinition() );
		columns.push( { id: 'group', name: 'Group', field: 'group', width: 200, headerCssClass: 'text-center', sortable: true });
		columns.push( { id: 'project', name: 'Project', field: 'project', width: 400, headerCssClass: 'text-center', formatter: project_formatter, sortable: true });
		columns.push( { id: 'branch_no', name: 'Branch', field: 'branch_no', width: 240, headerCssClass: 'text-center', formatter: branch_formatter, asyncPostRender: render_select, sortable: false});
		columns.push( { id: 'commit_no', name: 'Commit', field: 'commit_no', width: 180, headerCssClass: 'text-center', formatter: commit_formatter, asyncPostRender: render_select, sortable: false});

		var options = {
			multiColumnSort: true,
			enableCellNavigation: true,
			enableColumnReorder: false,
			rowHeight: 26,
			topPanelHeight: 26,
			enableAsyncPostRender: true
		};

		dataView = new Slick.Data.DataView({ inlineFilters: true });
		grid = new Slick.Grid( '#myGrid', dataView, columns, options );
		grid.setSelectionModel( new Slick.RowSelectionModel( { selectActiveRow: false } ) );
		grid.registerPlugin( checkboxSelector );
		var columnpicker = new Slick.Controls.ColumnPicker( columns, grid, options );

		resizer = new Slick.Plugins.Resizer( {
				container: '.container',
				// optionally define some padding and dimensions
				rightPadding: 5,	// defaults to 0
				bottomPadding: 10,	// defaults to 20
				minHeight: 150, 	// defaults to 180
				minWidth: 250,		// defaults to 300
			},
		);
		grid.registerPlugin( resizer );

		grid.onSelectedRowsChanged.subscribe(function (e, args) {
			var selectedrows = grid.getSelectedRows();
			$( '#download_all' ).prop( 'disabled', selectedrows.length == 0 );
			$( '#download_commits' ).prop( 'disabled', selectedrows.length == 0 );
			update_open_diff_button();
		} );

		grid.onClick.subscribe( function ( e, args ) {
			if ( args['cell'] <= 2 ) {		//	check, Group, Project ?
				$( document ).tooltip( 'destroy' );
				var selected = grid.getSelectedRows();
				var pos = selected.indexOf( args['row'] );
				if ( pos < 0 ) {
					selected.push( args['row'] );
				} else {
					selected.splice( pos, 1 );
				}
				grid.setSelectedRows( selected );
				$( document ).tooltip( {
					show: 10, hide: 10, track: true
				} )
			}
		} );

		grid.onSort.subscribe( function( e, args ) {
			sort_func( args );
		} );

		$("#gridContainer").resizable();

		$(".grid-header .ui-icon")
				.addClass("ui-state-default ui-corner-all")
				.mouseover(function (e) {
				  $(e.target).addClass("ui-state-hover")
				})
				.mouseout(function (e) {
				  $(e.target).removeClass("ui-state-hover")
				});
	}

	////////////////////////////////////////////////////////////////////
	function is_ignore_file_name( name ) {
		var pos = name.lastIndexOf( '/' );
		if ( pos >= 0 ) {
			name = name.substring( pos + 1 );
		}
		for ( var n = 0; n < config['ignore_file_name'].length; n ++ ) {
			var reg  =new RegExp( config['ignore_file_name'][n] );
			if ( name.match( reg ) ) return true;
		}
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function is_ignore_message( message ) {
		for ( var n = 0; n < config['ignore_commit_message'].length; n ++ ) {
			var reg  =new RegExp( config['ignore_commit_message'][n] );
			if ( message.match( reg ) ) return true;
		}
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function sort_func( args ) {
		dataView.syncGridSelection( grid, true );
		dataView.sort( function( a, b ) {
				for ( var i = 0, l = args.sortCols.length; i < l; i++ ) {
					var field = args.sortCols[i].columnId;
					if ( field == 'project' ) {
						field = 'name';
					}
					var sign = args.sortCols[i].sortAsc ? 1 : -1;
					var value1 = a[field], value2 = b[field];
					var result = (value1 == value2 ? 0 : (value1 > value2 ? 1 : -1)) * sign;
					if (result != 0) {
						return result;
					}
				}
			}, args.sortAsc );
		grid.invalidate();
		grid.render();
	}

	////////////////////////////////////////////////////////////////////
	function create_griddata( reset_groups ) {
		if ( reset_groups ) {
			var groups = [];
			for ( var n = 0; n < projects.length; n ++ ) {
				if ( !my_projects[projects[n]['id']] ) {
					continue;
				}
				var group = projects[n]['namespace']['name'];
				if ( groups.indexOf( group ) < 0 ) {
					groups.push( group );
				}
			}
			groups.sort();
			$( '#target_group' ).children().remove();
			$( '#target_group' ).append( $( '<option>' ).html( '' ) );
			for ( var n = 0; n < groups.length; n ++ ) {
				$( '#target_group' ).append( $( '<option>' ).html( groups[n] ) );
			}
		}
		var target_group = $( '#target_group' ).val();
		var target_branch = $( '#target_branch' ).val();
		griddata = [];
		for ( var n = 0; n < projects.length; n ++ ) {
			if ( !my_projects[projects[n]['id']] ) {
				continue;
			}
			if ( target_group != '' && projects[n]['namespace']['name'] != target_group ) continue;
			if ( target_branch == 'Tag' && projects[n]['tag'].length == 0 ) continue;
			var branch_no = 0;
			if ( target_branch == 'Branch' ) {
				for ( branch_no = 0; branch_no < projects[n]['branch'].length; branch_no ++ ) {
					if ( projects[n]['branch'][branch_no].default ) break;
				}
			}
			griddata.push( {
				id: projects[n].id,
				group: projects[n]['namespace']['name'],
				project: projects[n]['name'],
				path: projects[n].path_with_namespace,
				name: projects[n]['name'].toLowerCase().replace( /_/g, '' ).replace( /-/g, '' ),
				default_branch: projects[n]['default_branch'],
				branches: projects[n]['branch'],
				tags: projects[n]['tag'],
				branch_no: branch_no,
				commit_no: 0
			} );
		}
		console.log( griddata );
		dataView.setItems( griddata );
		var cols = grid.getColumns();
		cols[3]['name'] = target_branch;
		grid.setColumns( cols );
		sort_func( { sortCols: [ { columnId: 'group', sortAsc: true } ] } );
		grid.setSelectedRows( [] )
		grid.invalidate();
		grid.render();
	}

	////////////////////////////////////////////////////////////////////
	function checkbox_formatter( row, col, value, columnDef, dataContext ) {
		var no;
		for ( no = 0; no < griddata.length; no ++ ) {
			if ( griddata[no]['id'] == dataContext['id'] ) break;
		}
		var id = "checkbox_" + columnDef.id + '_' + no;
		var tag = '<input type="checkbox" id="' + id + '" '+
					'onclick="click_checkbox(this,event, ' + row + ',' + no + ',\'' + columnDef.field + '\');"';
		if ( value == true ) {
			tag += ' checked';
		}
		tag += '>';
		return tag;
	}

	////////////////////////////////////////////////////////////////////
	function project_formatter( row, col, value, columnDef, dataContext ) {
		var item = dataView.getItem( row );
		var target_branch = $( '#target_branch' ).val();
		var commit;
		if ( target_branch == 'Branch' ) {
			commit = item['branches'][item['branch_no']]['commits'][item['commit_no']];
		} else {
			commit = item['tags'][item['branch_no']]['commits'][item['commit_no']];
		}
		var message = commit['message'];
		if ( config['max_message_length'] > 0 ) {
			var eol = mbstrlen( message ) > config['max_message_length'] ? '...' : '';
			message = mbleft( message, config['max_message_length'] ) + eol;
		}
		var tag = '<span title="' + htmlspecialchars( message ) + '" class="fit_parent">' + value + '</span>';
		return tag;
	}

	////////////////////////////////////////////////////////////////////
	function branch_formatter( row, col, value, columnDef, dataContext ) {
		var no;
		for ( no = 0; no < griddata.length; no ++ ) {
			if ( griddata[no]['id'] == dataContext['id'] ) break;
		}
		var tag = '<select no="' + no + '" row="' + row + '" class="fit_parent change_branch">';
		var target_branch = $( '#target_branch' ).val();
		if ( target_branch == 'Branch' ) {
			for ( var n = 0; n < griddata[no]['branches'].length; n ++ ) {
				tag += '<option';
				if ( value == n ) {
					tag += ' selected';
				}
				tag += '>' + griddata[no]['branches'][n]['name'] + '</option>';
			}
		} else {
			for ( var n = 0; n < griddata[no]['tags'].length; n ++ ) {
				tag += '<option value="' + n + '"';
				if ( value == n ) {
					tag += ' selected';
				}
				tag += '>' + griddata[no]['tags'][n]['name'] + '</option>';
			}
		}
		tag += '</select>';
		return tag;
	}

	////////////////////////////////////////////////////////////////////
	function commit_formatter( row, col, value, columnDef, dataContext ) {
		var no;
		for ( no = 0; no < griddata.length; no ++ ) {
			if ( griddata[no]['id'] == dataContext['id'] ) break;
		}
		var target_branch = $( '#target_branch' ).val();
		if ( target_branch == 'Branch' ) {
			var tag = '<select no="' + no + '" row="' + row + '" class="fit_parent change_commit">';
			var commits = griddata[no]['branches'][griddata[no]['branch_no']];
			for ( var n = 0; n < commits['commits'].length; n ++ ) {
				if ( is_ignore_message( commits['commits'][n]['message'] ) ) continue;
				mark = is_mark_message( commits['commits'][n]['message'] );
				tag += '<option value="' + n + '"';
				if ( value == n ) {
					tag += ' selected';
				}
				tag += '>' + mark + format_date( commits['commits'][n]['committed_date'] ) + '</option>';
			}
			tag += '</select>';
		} else {
			var commits = griddata[no]['tags'][griddata[no]['branch_no']];
			tag = '<span class="fit_parent">' + format_date( commits['commits'][0]['committed_date'] ) + '</span>';
		}
		return tag;
	}

	////////////////////////////////////////////////////////////////////
	function is_mark_message( message ) {
				var mark = "";
		for ( var n = 0; n < config['mark_commit_message'].length; n ++ ) {
			var reg  =new RegExp( config['mark_commit_message'][n][0] );
			if ( message.match( reg ) ) {
				mark = config['mark_commit_message'][n][1];
				break;
			}
		}
		return mark;
	}

	////////////////////////////////////////////////////////////////////
	function render_select( cellNode, rowIdx, dataContext, colDef, cleanupBeforeRender ) {
		$( '.change_branch, .change_commit' ).off();
		$( '.change_branch, .change_commit' ).on( 'change', function( event ) {
			var sel = $( this );
			var row = sel[0].getAttribute( 'row' );
			var no = sel[0].getAttribute( 'no' );
			if ( sel[0].className.indexOf( 'change_branch' ) >= 0 ) {
				change_branch( sel[0], event, row, no );
			} else if ( sel[0].className.indexOf( 'change_commit' ) >= 0 ) {
				change_commit( sel[0], event, row, no );
			}
		} );
	}

	////////////////////////////////////////////////////////////////////
	function change_branch( select, event, row, no ) {
		event.stopPropagation();
		griddata[no]['branch_no'] = select.selectedIndex;
		griddata[no]['commit_no'] = 0;
		grid.invalidateRows( [ row ] );
		grid.render();
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function change_commit( select, event, row, no ) {
		event.stopPropagation();
		griddata[no]['commit_no'] = select.selectedIndex;
		grid.invalidateRows( [ row ] );
		grid.render();
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function format_date( date ) {
		var day = new Date( date );
		var yy = ( '00' + day.getFullYear() % 100 ).slice( -2 );
		var mm = ( '00' + ( day.getMonth() + 1 ) ).slice( -2 );
		var dd = ( '00' + day.getDate() ).slice( -2 );
		var hh = ( '00' + day.getHours() ).slice( -2 );
		var mi = ( '00' + day.getMinutes() ).slice( -2 );
		var ss = ( '00' + day.getSeconds() ).slice( -2 );
		return yy + '/' + mm + '/' + dd + ' ' + hh + ':' + mi + ':' + ss;
	}

	///////////////////////////////////////////////////////////////////
	function htmlspecialchars( str ) {
		return (str + '').replace(/&/g,'&amp;')
							.replace(/"/g,'&quot;')
							.replace(/'/g,'&#039;')
							.replace(/</g,'&lt;')
							.replace(/>/g,'&gt;');
	}

	///////////////////////////////////////////////////////////////////
	function mbstrlen( str ) {
		var len = 0;
		for ( var i = 0; i < str.length; i++ ) {
			if ( str.charCodeAt(i) <= 255 ) {
				len += 0.5;
			} else {
				len += 1;
			}
		}
		return len;
	}

	///////////////////////////////////////////////////////////////////
	function mbleft( str, len ) {
		var ret = '';
		for ( var i = 0; len > 0 && i < str.length; i ++ ) {
			if ( str[i].match( /[ -~]/ ) ) {
				len -= 0.5;
			} else {
				len -= 1;
			}
			ret += str[i];
		}
		return ret;
	}

	///////////////////////////////////////////////////////////////////
	function startProgress() {
		var html = '<div class="progress-label">Receiving Files...</div><br/>' +
					'<div style="white-space:nowrap; padding:0 8px 0 8px;">' +
					'<progress id="progress-bar" value="0" min="0" max="100">0%</progress> <output id="progress-pct">0</output>%</div><br/>' +
					'<button id="btn_cancel">Cancel</button><br/><br/>';
		$.blockUI( { message: html,
							overlayCSS:  {
								backgroundColor: '#aaa',
								opacity: 0.6,
								cursor: 'wait'
							},
							css: {
								width: '400px',
								height: '160px',
								color: '#black'
							}
						} );
		$( '#btn_cancel' ).on( 'click', function( e ) {
			cancel_request = true;
		} );
	}

	////////////////////////////////////////////////////////////////////
	function startWaiting() {
		var msg = '<img src="/js/SlickGrid/images/ajax-loader-small.gif"' +
				' border=0" style="vertical-align: middle; margin-right: 30px;">' +
				'<span style="font-size: 1.4em">Receiving...</span>';
		$.blockUI({
			message: msg,
			css: {
				padding: '19px 0 0 0',
				width: '250px',
				height: '50px',
				border: 'none',
				cursor: 'wait'
			}
		});
	}

	////////////////////////////////////////////////////////////////////
	function stopWaiting() {
		$.unblockUI();
	}

	////////////////////////////////////////////////////////////////////
	function input_txt_check( str ) {
	if( str == "."			||
		str == ".." 		||
		str.match( /^\s/g ) ||
		str.match( /\s$/g ) ) {
		alert( 'The wrong character was inputted.' );
		return false;
	}

	var bad_chars = '\\/:*?"<>|';
	for( var n = 0; n < bad_chars.length; n ++ ) {
		if( str.indexOf( bad_chars.charAt( n ) ) != -1 ) {
			alert( 'The wrong character was inputted.' );
			return false;
		}
	}
	var length = 0;
	for( var n = 0; n < str.length; n ++ ) {
		length ++;
		if( str.charCodeAt( n ) > config['default_download_name_maxlength'] ) length ++;
		if( length > config['default_download_name_maxlength'] ) {
			alert( 'File name too long.' );
			return false;
		}
	}
	return true;
	}

	////////////////////////////////////////////////////////////////////
	function simul_download_check( ) {

		if ( ( ! $( '#download_latest_commit_of_main' ).prop( 'checked' ) ) &&
			( ! $( '#download_previous_commit' ).prop( 'checked' ) ) ) return true;

		if ( ( $( '#download_latest_commit_of_main' ).prop( 'checked' ) ) &&
			( $( '#download_previous_commit' ).prop( 'checked' ) ) ) {
			alert( '"最新のメイン"と"一つ前のコミット"は、どちらかしか選択できません。' );
			return false;
		}

		simul_download_flag = 'On';
		var rows = grid.getSelectedRows();
		if ( $( '#download_latest_commit_of_main' ).prop( 'checked' ) ) {
			for ( var n = 0; n < rows.length; n ++ ) {
				if ( latest_commit_of_main_check( rows[n] ) == true ) {
					return true;
				}
			}
			alert( '全Project 最新のメインのため、同時にダウンロードが行えません。' );
		} else {
			for ( var n = 0; n < rows.length; n ++ ) {
				if ( previous_commit_check( rows[n] ) == true ) {
					return true;
				}
			}
			alert( '全Project 一つ前のコミットがないため、同時にダウンロードが行えません。' );
		}
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function latest_commit_of_main_check( row ) {
		var value = dataView.getItem( row );
		if ( value['branches'][value['branch_no']]['name'] != value['default_branch'] ) return true;
		if ( value['commit_no'] != 0 ) return true;
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function previous_commit_check( row ) {
		var value = dataView.getItem( row );
		var branch = value['branches'][value['branch_no']];
		if ( branch['commits'][value['commit_no']]['parent_ids']['length'] != 0 ) return true;
		return false;
	}

	////////////////////////////////////////////////////////////////////
	function checkout_checkbox( checkbox_id ) {
		let element = document.getElementById(checkbox_id);
		element.checked = false;
		update_open_diff_button();
	}

	function update_open_diff_button() {
		var selectedrows = grid.getSelectedRows();
		var enabled = selectedrows.length != 0 &&
								( $( '#download_latest_commit_of_main' ).prop( 'checked' ) ||
								$( '#download_previous_commit' ).prop( 'checked' ) );
		var title = '';
		if ( enabled ) {
			title = ( $( '#download_latest_commit_of_main' ).prop( 'checked' ) ? '最新のデフォルトブランチ' : '１つ前のコミット' ) + 'との diff を表示します';
		}
		$( '#open_diff' ).prop( 'disabled', !enabled ).prop( 'title', title );;
	}

</script>

</head>
<body>

<table border=0 cellpadding=0 cellspacing=4>
<thead></thead>
<tbody>
<tr>
<td align="right"><button id="download_all" title="選択したコミットの全体を取得">全体取得</button></td>
<td><select id="download_all_type">
<option>tar.gz</option>
<option>zip</option>
</select></td>
<td style="width:120px;">&nbsp;</td>
<td><input type="checkbox" id="including_project"><label style="font-size:14px" for="including_project">プロジェクト名を含んでダウンロード</label></td>
<td><input type="checkbox" id="download_latest_commit_of_main" onclick="checkout_checkbox('download_previous_commit')"><label
style="font-size:14px" for="download_latest_commit_of_main">最新のデフォルトブランチと同時にダウンロード</label></td>
</td>
</tr>

<tr>
<td align="right"><button id="download_commits" title="直前のコミットとの差分を取得">差分取得</button></td>
<td><select id="download_commits_type">
<option>tar.gz</option>
<option>zip</option>
</select></td>
<td>&nbsp;</td>
<td><label style="font-size:14px">ダウンロードファイル名：<input type="text" size="20" value="" id="download_file_name"></label></td>
<td><input type="checkbox" id="download_previous_commit" onclick="checkout_checkbox('download_latest_commit_of_main')"><label
style="font-size:14px" for="download_previous_commit">一つ前のコミットと同時にダウンロード</label></td>
</tr>

<tr>
<td align="right">Group: </td>
<td><select id="target_group">
<option></option>
</select></td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td><button id="open_diff" title="">diff 表示</button></td>
</tr>

<tr>
<td align="right">Branch/Tag: </td>
<td><select id="target_branch">
<option>Branch</option>
<option>Tag</option>
</select></td>
<td>&nbsp;</td>
<td><button id="reload_repository" style="visibility:hidden;" title="一覧を最新に更新">最新に更新</button></td>
<td align="right"><button id="logout" title="ログアウトします">ログアウト</button></td>
</tr>

</tbody>
</table>

<div class="container" style="width:100%;height:600px;margin-top:8px;">
<div id="myGrid" style="width:100%;height:100%;"></div>
</div>

<iframe id="download_frame" style="display:none;"></iframe>

</body>
</html>
